<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced CPU Signal Flow with Cache</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .component {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
            position: absolute; /* Needed for positioning */
        }
        .component.active {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            border-color: #3b82f6; /* blue-500 */
        }
        .signal {
            width: 20px;
            height: 20px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            position: absolute;
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 10;
        }
        .signal.active {
            opacity: 1;
        }
        .path {
            position: absolute;
            stroke-dasharray: 5;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }
        .info-box {
            min-height: 100px;
        }
        #cpu-boundary {
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">CPU Signal Flow with Cache Memory</h1>
        <p class="text-gray-600 dark:text-gray-300 mt-2">Illustrating Cache Hits and Misses in the Fetch Cycle.</p>
    </div>

    <div id="animation-container" class="relative w-full max-w-6xl h-[550px] bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
        <!-- SVG for drawing paths -->
        <svg id="path-svg" class="absolute top-0 left-0 w-full h-full" style="z-index: 0;"></svg>

        <!-- Components -->
        <div id="input" class="component bg-green-100 dark:bg-green-900 border-2 border-green-300 dark:border-green-700 text-green-800 dark:text-green-200 w-28 h-24 rounded-lg" style="left: 2%; top: 40%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12h-2m2 0v-2m0 2v2m2 0h2"/><path d="M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"/></svg>
            <span class="font-semibold mt-1">Input</span>
        </div>
        
        <div id="cpu-boundary" class="absolute border-2 border-dashed border-blue-400 dark:border-blue-600 rounded-lg" style="left: 25%; top: 10%; width: 50%; height: 80%;">
            <span class="absolute -top-3.5 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-blue-500 font-semibold text-lg">Central Processing Unit (CPU)</span>
            <div id="control-unit" class="component bg-cyan-100 dark:bg-cyan-900 border-2 border-cyan-300 dark:border-cyan-700 text-cyan-800 dark:text-cyan-200 w-32 h-24 rounded-lg" style="left: 50%; top: 10%; transform: translateX(-50%);">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 7 1.4-1.4"/><path d="m6.4 17.6 1.4-1.4"/><path d="M22 12h-2"/><path d="M4 12H2"/><path d="m17.6 17.6-1.4-1.4"/><path d="m7.4 6.4-1.4-1.4"/></svg>
                <span class="font-semibold mt-1">Control Unit</span>
            </div>
            <div id="alu" class="component bg-yellow-100 dark:bg-yellow-900 border-2 border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200 w-32 h-24 rounded-lg" style="left: 20%; top: 45%;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 7h10"/><path d="M2 17h10"/><path d="m7 2 5 5-5 5"/><path d="m7 12 5 5-5 5"/></svg>
                <span class="font-semibold mt-1">ALU</span>
            </div>
            <div id="registers" class="component bg-indigo-100 dark:bg-indigo-900 border-2 border-indigo-300 dark:border-indigo-700 text-indigo-800 dark:text-indigo-200 w-32 h-24 rounded-lg" style="left: 50%; top: 45%; transform: translateX(-50%);">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h1"/><path d="M6 3h1"/><path d="M10 3h1"/><path d="M14 3h1"/><path d="M18 3h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1"/><path d="M20 11h-1"/><path d="M16 11h-1"/><path d="M12 11h-1"/><path d="M8 11H7"/><path d="M4 21a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1"/><path d="M6 13h1"/><path d="M10 13h1"/><path d="M14 13h1"/><path d="M18 13h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1"/><path d="M20 21h-1"/><path d="M16 21h-1"/><path d="M12 21h-1"/><path d="M8 21H7"/></svg>
                <span class="font-semibold mt-1">Registers</span>
            </div>
            <div id="cache" class="component bg-orange-100 dark:bg-orange-900 border-2 border-orange-300 dark:border-orange-700 text-orange-800 dark:text-orange-200 w-32 h-24 rounded-lg" style="right: 20%; top: 45%;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 5-3 3-3-3"/><path d="m6 11 4 4 4-4"/><path d="m12 19-3-3 3-3"/></svg>
                <span class="font-semibold mt-1">Cache</span>
            </div>
        </div>

        <div id="memory" class="component bg-purple-100 dark:bg-purple-900 border-2 border-purple-300 dark:border-purple-700 text-purple-800 dark:text-purple-200 w-28 h-24 rounded-lg" style="right: 2%; top: 15%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M6 10h4"/><path d="M6 14h8"/><path d="m14 10 4 4"/><path d="m18 10-4 4"/></svg>
            <span class="font-semibold mt-1">Memory</span>
        </div>

        <div id="output" class="component bg-red-100 dark:bg-red-900 border-2 border-red-300 dark:border-red-700 text-red-800 dark:text-red-200 w-28 h-24 rounded-lg" style="right: 2%; top: 65%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12h-2m2 0v-2m0 2v2m2 0h2"/><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="m16 12-4 4-4-4"/></svg>
            <span class="font-semibold mt-1">Output</span>
        </div>
        
        <div id="signal" class="signal"></div>
    </div>
    
    <div class="w-full max-w-6xl mt-6">
        <div id="info-box" class="info-box bg-white dark:bg-gray-800 rounded-lg p-4 text-center shadow-md">
            <p id="info-text" class="text-gray-700 dark:text-gray-200 text-lg transition-opacity duration-500">Click a scenario to start the animation.</p>
        </div>
    </div>
    
    <div class="mt-6 flex flex-wrap justify-center gap-4">
        <button id="cache-hit-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
            Run 'Cache Hit'
        </button>
        <button id="cache-miss-btn" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
            Run 'Cache Miss'
        </button>
        <button id="custom-flow-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
            Run Custom Flow
        </button>
        <button id="reset-btn" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-transform transform hover:scale-105">
            Reset
        </button>
    </div>

    <script>
        const elements = {
            input: document.getElementById('input'),
            controlUnit: document.getElementById('control-unit'),
            alu: document.getElementById('alu'),
            registers: document.getElementById('registers'),
            cache: document.getElementById('cache'),
            memory: document.getElementById('memory'),
            output: document.getElementById('output'),
            signal: document.getElementById('signal'),
            cacheHitBtn: document.getElementById('cache-hit-btn'),
            cacheMissBtn: document.getElementById('cache-miss-btn'),
            customFlowBtn: document.getElementById('custom-flow-btn'),
            resetBtn: document.getElementById('reset-btn'),
            infoText: document.getElementById('info-text'),
            pathSvg: document.getElementById('path-svg')
        };

        let animationTimeout;
        let isAnimating = false;

        const messages = {
            hit: [
                "1. (Fetch) An instruction is sent from Input to the Control Unit.",
                "2. (Decode) The CU decodes the instruction, which requires data.",
                "3. The CU first checks the high-speed Cache for the data.",
                "4. CACHE HIT! The data is found in the cache. This is very fast.",
                "5. The data is sent from the Cache to a Register.",
                "6. (Execute) The Register sends data to the ALU for calculation.",
                "7. The result is sent back from the ALU to the Register.",
                "8. The final result is sent to the Output.",
                "Animation Complete. A 'Cache Hit' significantly speeds up processing."
            ],
            miss: [
                "1. (Fetch) An instruction is sent from Input to the Control Unit.",
                "2. (Decode) The CU decodes the instruction, which requires data.",
                "3. The CU first checks the high-speed Cache for the data.",
                "4. CACHE MISS! The data is NOT in the cache. The CPU must check main Memory.",
                "5. The request is sent to the much slower main Memory.",
                "6. Memory finds the data and sends it back to the CPU.",
                "7. The data is first stored in the Cache for future use.",
                "8. Now the data is sent from the Cache to a Register.",
                "9. (Execute) The Register sends data to the ALU for calculation.",
                "10. The result is sent back from the ALU to the Register.",
                "11. The final result is sent to the Output.",
                "Animation Complete. A 'Cache Miss' is slower because of the extra trip to Memory."
            ],
            custom: [
                "1. An instruction is sent from the Input device.",
                "2. The signal enters the CPU, arriving at the Control Unit.",
                "3. The CU coordinates with the ALU for calculations...",
                "4. ...it checks the high-speed Cache for frequently used data...",
                "5. ...and uses Registers for temporary storage during processing.",
                "6. After CPU processing, the result is sent to Main Memory for storage.",
                "7. Finally, the data is retrieved and sent to an Output device.",
                "Custom Flow Complete. This demonstrates a general data path."
            ]
        };

        function getCenter(el) {
            const rect = el.getBoundingClientRect();
            const containerRect = el.offsetParent.getBoundingClientRect();
            return {
                x: rect.left - containerRect.left + rect.width / 2,
                y: rect.top - containerRect.top + rect.height / 2
            };
        }

        function drawPaths() {
            elements.pathSvg.innerHTML = '';
            const pathData = [
                { from: elements.input, to: elements.controlUnit },
                { from: elements.controlUnit, to: elements.cache },
                { from: elements.controlUnit, to: elements.alu },
                { from: elements.controlUnit, to: elements.registers },
                { from: elements.controlUnit, to: elements.output },
                { from: elements.cache, to: elements.memory },
                { from: elements.cache, to: elements.registers },
                { from: elements.memory, to: elements.cache },
                { from: elements.registers, to: elements.alu },
                { from: elements.registers, to: elements.output },
                { from: elements.alu, to: elements.registers },
                // Custom path for direct memory to output
                { from: elements.memory, to: elements.output }
            ];
            
            pathData.forEach(p => {
                const fromCenter = getCenter(p.from);
                const toCenter = getCenter(p.to);
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M${fromCenter.x} ${fromCenter.y} L${toCenter.x} ${toCenter.y}`);
                path.setAttribute('stroke', '#9ca3af');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.classList.add('path');
                elements.pathSvg.appendChild(path);
            });
        }
        
        function updateTextAndHighlight(scenario, index, activeEl) {
            elements.infoText.style.opacity = '0';
            setTimeout(() => {
                elements.infoText.textContent = messages[scenario][index];
                elements.infoText.style.opacity = '1';
            }, 300);

            document.querySelectorAll('.component').forEach(el => el.classList.remove('active'));
            if (activeEl) {
                activeEl.classList.add('active');
            }
        }

        function moveSignal(targetEl, duration = 1500) {
            return new Promise(resolve => {
                const center = getCenter(targetEl);
                elements.signal.style.transition = `all ${duration / 1000}s cubic-bezier(0.4, 0, 0.2, 1)`;
                elements.signal.style.left = `${center.x - elements.signal.offsetWidth / 2}px`;
                elements.signal.style.top = `${center.y - elements.signal.offsetHeight / 2}px`;
                animationTimeout = setTimeout(resolve, duration);
            });
        }
        
        function disableButtons() {
            isAnimating = true;
            elements.cacheHitBtn.disabled = true;
            elements.cacheMissBtn.disabled = true;
            elements.customFlowBtn.disabled = true;
            elements.cacheHitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            elements.cacheMissBtn.classList.add('opacity-50', 'cursor-not-allowed');
            elements.customFlowBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function startAnimation(scenario) {
            if (isAnimating) return;
            disableButtons();
            
            const inputCenter = getCenter(elements.input);
            elements.signal.style.transition = 'none';
            elements.signal.style.left = `${inputCenter.x - elements.signal.offsetWidth / 2}px`;
            elements.signal.style.top = `${inputCenter.y - elements.signal.offsetHeight / 2}px`;
            await new Promise(r => setTimeout(r, 100));
            elements.signal.classList.add('active');
            
            if (scenario === 'hit') {
                updateTextAndHighlight('hit', 0, elements.input);
                await moveSignal(elements.controlUnit);
                updateTextAndHighlight('hit', 1, elements.controlUnit);
                await new Promise(r => animationTimeout = setTimeout(r, 1500));
                updateTextAndHighlight('hit', 2, elements.controlUnit);
                await moveSignal(elements.cache);
                updateTextAndHighlight('hit', 3, elements.cache);
                await new Promise(r => animationTimeout = setTimeout(r, 1000));
                updateTextAndHighlight('hit', 4, elements.cache);
                await moveSignal(elements.registers);
                updateTextAndHighlight('hit', 5, elements.registers);
                await moveSignal(elements.alu);
                updateTextAndHighlight('hit', 6, elements.alu);
                await moveSignal(elements.registers);
                updateTextAndHighlight('hit', 7, elements.registers);
                await moveSignal(elements.output);
                updateTextAndHighlight('hit', 8, null);
            } else if (scenario === 'miss') {
                updateTextAndHighlight('miss', 0, elements.input);
                await moveSignal(elements.controlUnit);
                updateTextAndHighlight('miss', 1, elements.controlUnit);
                await new Promise(r => animationTimeout = setTimeout(r, 1500));
                updateTextAndHighlight('miss', 2, elements.controlUnit);
                await moveSignal(elements.cache);
                updateTextAndHighlight('miss', 3, elements.cache);
                await new Promise(r => animationTimeout = setTimeout(r, 1000));
                updateTextAndHighlight('miss', 4, elements.cache);
                await moveSignal(elements.memory);
                updateTextAndHighlight('miss', 5, elements.memory);
                await moveSignal(elements.cache, 2000);
                updateTextAndHighlight('miss', 6, elements.cache);
                await new Promise(r => animationTimeout = setTimeout(r, 1000));
                updateTextAndHighlight('miss', 7, elements.cache);
                await moveSignal(elements.registers);
                updateTextAndHighlight('miss', 8, elements.registers);
                await moveSignal(elements.alu);
                updateTextAndHighlight('miss', 9, elements.alu);
                await moveSignal(elements.registers);
                updateTextAndHighlight('miss', 10, elements.registers);
                await moveSignal(elements.output);
                updateTextAndHighlight('miss', 11, null);
            } else if (scenario === 'custom') {
                updateTextAndHighlight('custom', 0, elements.input);
                await moveSignal(elements.controlUnit);
                updateTextAndHighlight('custom', 1, elements.controlUnit);
                await moveSignal(elements.alu);
                updateTextAndHighlight('custom', 2, elements.alu);
                await moveSignal(elements.cache);
                updateTextAndHighlight('custom', 3, elements.cache);
                await moveSignal(elements.registers);
                updateTextAndHighlight('custom', 4, elements.registers);
                await moveSignal(elements.memory);
                updateTextAndHighlight('custom', 5, elements.memory);
                await moveSignal(elements.output);
                updateTextAndHighlight('custom', 6, elements.output);
                await new Promise(r => animationTimeout = setTimeout(r, 1500));
                updateTextAndHighlight('custom', 7, null);
            }
            elements.signal.classList.remove('active');
        }

        function resetAnimation() {
            clearTimeout(animationTimeout);
            isAnimating = false;

            const inputCenter = getCenter(elements.input);
            elements.signal.classList.remove('active');
            elements.signal.style.transition = 'none';
            elements.signal.style.left = `${inputCenter.x - elements.signal.offsetWidth / 2}px`;
            elements.signal.style.top = `${inputCenter.y - elements.signal.offsetHeight / 2}px`;
            
            document.querySelectorAll('.component').forEach(el => el.classList.remove('active'));
            elements.infoText.textContent = "Click a scenario to start the animation.";

            elements.cacheHitBtn.disabled = false;
            elements.cacheMissBtn.disabled = false;
            elements.customFlowBtn.disabled = false;
            elements.cacheHitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            elements.cacheMissBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            elements.customFlowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        elements.cacheHitBtn.addEventListener('click', () => startAnimation('hit'));
        elements.cacheMissBtn.addEventListener('click', () => startAnimation('miss'));
        elements.customFlowBtn.addEventListener('click', () => startAnimation('custom'));
        elements.resetBtn.addEventListener('click', resetAnimation);
        
        window.onload = () => {
            drawPaths();
            resetAnimation();
        };
        window.onresize = () => {
            drawPaths();
            if (!isAnimating) {
               resetAnimation();
            }
        };
    </script>
</body>
</html>